---
title: "An Introduction to R"
author: "Peter Humburg"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
    ioslides_presentation:
        template: template/mq_workshop.html
        widescreen: true
        fig_height: 7
        fig_width: 7
        logo: icons\\mq_logo_wide.png
        includes:
            in_header: 
                - include/fonts.html
                - include/jQuery.html
        self_contained: true
css: css/slide.css
logo_small: icons/mq_logo.png
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(readr)

title <- rmarkdown::metadata$title
author <- rmarkdown::metadata$author
```

<script>
    $(document).ready(function() {
      $('slide:not(.title-slide, .backdrop, .segue)').append('<footer data-title=\"`r title`\" data-author=\"`r author`\"></footer>');    
    })
</script>

# Getting started
## RStudio
```{r, out.width = "800px"}
knitr::include_graphics("figures/RStudio_startup.png")
```

## RStudio
```{r, out.width="800px"}
knitr::include_graphics("figures/RStudio_startup_labelled.png")
```

<div class="notes">
* Could start working now by typing R commands, but better to keep a record of
  what we are doing.
* Notebooks integrate R code with comments and and output.
</div>

## Notebooks
```{r, out.width="400px"}
knitr::include_graphics("figures/create_notebook.png")
```

<div class="tryit">
Create a new notebook in RStudio.
</div>

<div class="notes">
* Time to open a notebook in RStudio
</div>

## Adding text to a notebook
* Simply type!
* Create sections with `#`.
* Subsections can be created with `##` and `###`.
* Highlight text by surrounding it with `*` for *italics*.
* Use `**` for **bold**.

<div class="tryit">
Type some text into the notebook and experiment with formatting.
</div>

## Preview results
```{r, out.width="400px"}
knitr::include_graphics("figures/preview_notebook.png")
```

<div class="tryit">
* Take a look at the rendered results.
* Try exporting to PDF or Word.
</div>


## Adding R code
* Blocks of R code start with ` ```{r}`
* and end with ` ``` `

` ```{r} `

   `# fancy computations here`

` ``` `

<div class="tryit">
Add a code block to your notebook.
</div>
<div class="hint">
* <i class="fa fa-windows" aria-hidden="true"></i> <kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>I</kbd> may help.
* <i class="fa fa-apple" aria-hidden="true"></i> <kbd>&#x2318;</kbd>+<kbd>Option</kbd>+<kbd>I</kbd> may help.
</div>

## Storing values
* Want to assign a name to data so we can use it in computations
* Assign values to variables
* Values can be simple (e.g. `5` or `"dog"`)
* ... or complex (e.g. all the data from your study)

```{r assignment, echo=TRUE}
ans <- 42
```

<div class="tryit">
Add a variable assignment to your code chunk.
</div>


## Executing R code {.columns-2}

```{r, out.width="400px"}
knitr::include_graphics("figures/run_chunks.png")
```

Execute current line of code:

* <i class="fa fa-windows" aria-hidden="true"></i> <kbd>Ctrl</kbd>+<kbd>Enter</kbd>
* <i class="fa fa-apple" aria-hidden="true"></i> <kbd>&#x2318;</kbd>+<kbd>Enter</kbd>

Execute entire code block:

* <i class="fa fa-windows" aria-hidden="true"></i> <kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>Enter</kbd>
* <i class="fa fa-apple" aria-hidden="true"></i> <kbd>&#x2318;</kbd>+<kbd>Shift</kbd>+<kbd>Enter</kbd>

## Examining values {.columns-2}
```{r, out.width="600px"}
knitr::include_graphics("figures/environment.png")
```

* View values in the *Environment* window.
* Use the data viewer
    - Try `View(ans)`
* `print` values
    - Try `print(ans)`
* Hightlight variable name in notebook + <kbd>Ctrl</kbd>+<kbd>Enter</kbd>

## Basic building blocks -- Vectors
* Data is stored in vectors
* Each vector has a *type*
    * *numeric* for intervall and ratio data
    * *logical* for binary data/truth values
    * *character* or *factor* for categorical data
    * ...

<div class="tryit">
```r
1:5
logical(3)
letters
factor(letters)
```
</div>
    
## Basic building blocks -- Vectors
* Vectors can have multiple dimensions.

<div class="tryit">
```r
mat <- matrix(1:12, ncol=3)
dim(mat)
mat[2, 3]
```
</div>

* Different types of vectors can be combined into *lists*.
* Vectors of the same length can be combined into *data frames*.

<div class="tryit">
```r
lst <- list(position=1:26, letter=letters)
lst[[2]][3]
lst$letter[3]
df <- data.frame(position=1:26, letter=letters)
df[3, 2]
```
</div>

## Basic building blocks -- Functions
* Functions transform data.
* Input remains unchanged.

```{r, out.width="600px"}
knitr::include_graphics("figures/functions.png")
```

## Working with variables {.columns-2}
We can manipulate variables in multiple ways

* Arithmetic
* Comparison
* Combine, split, search

```{r, echo=TRUE}
x <- c(ans, ans/2, ans/3, ans/7)
y <- x*x
z <- x + y
p1 <- z/x
eq <- x == p1 - 1
small_idx <- which(x < 20)
small <- x[small_idx]
```
<br><br>

<div class="hint">
* `+`, `-`, `/`, `*` are arithmetic operators.
* `==`, `<`, `>`, `<=`, `>=` are comparison operators.
* `c` concatenates variables.
* `[` extracts subset of a vector.
</div>
<div class="tryit">
* What happens if an operator is applied to a vector?
* What does `which` do?
</div>

## Getting help {.columns-2}
```{r, out.width="500px"}
knitr::include_graphics("figures/help_browser.png")
```

* Use RStudio's help browser.
* Use the `?` command.

<div class="tryit">
Look at the help page for the `which` function.
</div>

<div class="hint">
A lot of useful information is available online.
</div>

# Working with data
## Importing data
```{r, out.width="800px"}
knitr::include_graphics("figures/import_data.png")
```

## Importing data
```{r, out.width="800px"}
knitr::include_graphics("figures/import_window.png")
```

```{r, include=FALSE}
probly <- read_csv("C:/Users/MQ41055780/OneDrive - Macquarie University/Workshops/Rintro/data/probly.csv")
```

## Tidying data
*Tidy* data should have

* One variable per column.
* One observation per row.

<div class="discuss">
* What is the structure of the dataset?
* What are the rows/columns?
* Is this tidy data?
</div>

## Tidying data
It depends on the question we want to ask of the data!

* Each colum could be considered a different level of the same variable.
* Or a different variable.
* Note that column with supject ID is missing.


## Using the `tidyr` package
Allows easy reformatting of data to make it tidy.
 
```{r, echo=TRUE, warning=FALSE, message=FALSE}
library(tidyverse)
```
<div class="columns-2">
```{r, out.width="475px"}
knitr::include_graphics("figures/tidyr_gather.png")
```
<br><br>
```{r, eval=FALSE, echo=TRUE}
gather(table4a, `1999`, `2000`, 
       key = "year", value = "cases")
```

```{r, out.width="400px"}
knitr::include_graphics("figures/tidyr_spread.png")
```
```{r, echo=TRUE, eval=FALSE}
spread(table2, type, count)
```
</div>

## Reshaping data {.build}

<div class="tryit">
Tidy up the *probly* dataset by gathering all reported probabilities into a single column.
</div>

<div class="hint">
First add a *subject* column.
</div>
<div class="hint">
```{r, echo=TRUE}
probly <- add_column(probly, subject=1:nrow(probly), .before=1)
```

</div>
<div class="hint">
```{r, echo=TRUE}
probly_long <- gather(probly, `Almost Certainly`:`Chances Are Slight`, 
                      key="phrase", value="probability")
```

</div>

# Visualising data
## Plotting with `ggplot2`

* A plot only really needs three things
    * data
    * mapping of data to geometric objects
    * coordinate system
* `ggplot2` provides an easy way to combine these elements
  into plots.
  
`ggplot(`<span class="varblock">data</span>`) + geom_`<span class="varblock">type</span>`(aes(`<span class="varblock">aesthetics</span>`))`

**data**: a `data.frame` with your data.

**geom**: Geometric object to use to visualise the data.

**aesthetics**: Mapping of variables to properties of the *geom* (location, colour, size, ...)

## Plotting data {.build}

<div class="tryit">
Create a simple box plot of the data.
</div>
<div class="hint">
```{r, echo=TRUE, warning=FALSE, message=FALSE}
library(ggplot2)
```

Use `geom_boxplot`
</div>


## Plotting data
<div class="centered">
```{r, echo=TRUE, out.width="400px"}
ggplot(probly_long) + geom_boxplot(aes(x=phrase, y=probability))
```
</div>

## Improving the box plot

<div class="tryit">
* Can't really read the labels. Can we fix that?
</div>

<div class="hint">
Take a look at the help page for `geom_boxplot`, the examples may provide inspiration.
</div>

<div class="notes">
Give participants some time to look at this. Answer questions and give hints as necessary.
</div>

## Improved box plot

```{r boxplot_impr, echo=TRUE, out.height="450px", out.width="450px"}
ggplot(probly_long) + geom_boxplot(aes(x=phrase, y=probability)) + coord_flip()
```

## Improved box plot (alternative solution)

```{r, echo=TRUE, out.height="400px", out.width="400px"}
ggplot(probly_long) + geom_boxplot(aes(x=phrase, y=probability)) +
  theme(axis.text.x=element_text(angle=45,hjust=1))
```

## Further improvements

* Plot is still hard to read.
* Would be helpful to order phrases by percieved probability.
* How do we tell `ggplot` which order to use?

<div class="build">
<div class="hint">
* Factor levels are ordered alphabetically by default.
* The `forcats` package supports reordering factor levels based on another variable.

```{r, echo=TRUE}
library(forcats)
```
</div>
</div>

## Ordered plot

```{r box_order, echo=TRUE, eval=FALSE}
ggplot(probly_long) + geom_boxplot(aes(x=fct_reorder(phrase, probability), 
                                       y=probability)) + coord_flip()
```

<div class="centered">
```{r box_order, echo=FALSE, eval=TRUE, out.width="450px", out.height="450px"}
```
</div>

## Final tweaks

<div class="tryit">
1. <span class="red">Fix the y axis label.</span>
2. Use colour to highlight differences between categories.
</div>

<div class="hint">
Search the help system for a way to change the axis label.
</div>

<div class="build">
<div class="hint">
The `xlab` and `ylab` function will set the axis labels. Remember that we flipped the coordinate system.

```{r, echo=TRUE, eval=FALSE}
ggplot(probly_long) + geom_boxplot(aes(x=fct_reorder(phrase, probability), 
                                       y=probability)) +
### <b>
  xlab("phrase") + coord_flip()
### </b>
```
</div>
</div>

## Final tweaks

<div class="tryit">
1. Fix the y axis label.
2. <span class="red">Use colour to highlight differences between categories.</span>
</div>

<div class="hint">
* Group observations by phrase using the `group_by` function.
* New variables can be added with the `mutate` function.
</div>

<div class="build">
<div class="hint">
```{r, echo=TRUE}
probly_long <- group_by(probly_long, phrase)
probly_long <- mutate(probly_long, avg=median(probability))
```
</div>
</div>

## Coloured plot
```{r boxplot_colour, echo=TRUE, eval=FALSE}
ggplot(probly_long) + geom_boxplot(aes(x=fct_reorder(phrase, probability), 
                                       y=probability,
## <b>
                                       fill=avg)) + 
## </b>
  xlab("phrase") + coord_flip()

```

## Coloured plot {.centered}
```{r boxplot_colour, echo=FALSE, eval=TRUE, out.width="500px", out.height="500px"}
```

## Adjusting scales
* `ggplot` chose a single colour gradient to visualise median probabilities.
* A divergent scale centred on 50% would make a lot more sense.

<div class="hint">
* Scales for *aesthetics* can be adjusted via `scale` functions.
* `scale_`<span class="varblock">aesthetic</span>`_`<span class="varblock">type<span>
* scale types include *manual*, *discrete*, *continuous*, ...
</div>

<div class="build">
<div class="hint">
`scale_fill_gradient2(midpoint=50)`
</div>
</div>

## Final plot

```{r boxplot_final, echo=TRUE, eval=FALSE}
ggplot(probly_long) + geom_boxplot(aes(x=fct_reorder(phrase, probability), 
                                       y=probability, fill=avg)) + 
  xlab("phrase") + coord_flip() +
### <b>
  scale_fill_gradient2(midpoint=50)
### </b>
```

## Final plot {.centered}

```{r boxplot_final, echo=FALSE, eval=TRUE, out.width="500px", out.height="500px"}
```